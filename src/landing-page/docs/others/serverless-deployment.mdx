---
path: '/docs/others/serverless-deployment'
title: 'Serverless deployment'
order: 0
section: 'others'
sectionOrder: 4
---

# Serverless production

You can consider this article as a basic guide to the serverless concept. There is tons of different configurations on your demand. Just be careful with your sensitive data, like keys and passwords. Make sure you do

## Prepare ZEIT Now

- Create account if you don't have it
- Connect GitHub and give access to all repositories

## Clone the fork you made previously. Specify the custom name of the folder

```shell
$ git clone git@github.com:username/app-name.git app-name-prod
$ cd app-name-prod/
```

## Remove push link from git remotes:

We should only be able to pull changes from the public development environment. Pushing code there could lead to undesirable consequences.

```shell
$ git remote set-url --push origin no_push
$ git remote -v
origin  git@github.com:username/app-name.git (fetch)
origin  no_push (push)
$ git pull
Already up to date.
```

## Create private repository on GitHub

Make sure it **private**. We'll push production code there with all sensitive data, where ZEIT Now and Netlify automatically make it live. We recommend to add `*-prod` prefix.

## Set up production remote and upstream

```shell
$ git remote add prod git@github.com:username/app-name-prod.git
$ git remote -v
origin  git@github.com:username/app-name.git (fetch)
origin  no_push (push)
prod    git@github.com:username/app-name-prod.git (fetch)
prod    git@github.com:guandjoy/app-name-prod.git (push)
$ git push --set-upstream prod master
```

## Prepare `settings.py` file

- First change directory `cd src/django_server/django_server/`
- Dublicate and rename `settings.serverless.py` template as `settings.py`:

```shell
$ cp settings.serverless.py settings.py
```

- Remove `settings.py` from `src/django_server/django_server/.gitignore`, so ZEIT Now could access them.

_WARNING: Make sure your production remote repository is **private**. It is not to late to fix that, since you did not push your real credentials._

## Specify `SECRET_KEY`

- Generate the key:

```shell
$ python ../redfish/generate_secret_key.py
Paste the next string to the settings.py SECRET_KEY constant
h*)8i!tn^bobbzd-f95b@gn0=^o6a6kruhp6mgk52!h39u6%@p
```

- Copy and paste it to the `settings.py` file:

```python
# src/django_server/django_server/settings.py
...
# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'h*)8i!tn^bobbzd-f95b@gn0=^o6a6kruhp6mgk52!h39u6%@p'
...
```

## SMTP server

Copy SMTP settings from the development build you've made previosly:

```python
# src/django_server/django_server/settings.py
...
EMAIL_HOST_USER = 'example@gmail.com'
EMAIL_HOST_PASSWORD = 'tbbeqrspnppnxdza'
...
```

## AWS authentication

- Go to [AWS Regions and Endpoints](https://docs.aws.amazon.com/general/latest/gr/rande.html), copy and paste the value of your region:

```python
# src/django_server/django_server/settings.py
...
# The AWS region to connect to.
AWS_REGION = "eu-central-1"
...
```

- Go to [IAM Management Console](https://console.aws.amazon.com/iam/home?#/users) and **create a new user** with **Programmatic access**.
- Create a group with **AmazonRDSFullAccess** and **AmazonS3FullAccess** policies and add created user there.
- Copy **Access Key ID** and **Secret Access Key** and paste them into `settings.py` file

```python
# src/django_server/django_server/settings.py
...
# The AWS access key to use.
AWS_ACCESS_KEY_ID = "AKIAR2BBJGZAVGG2RF6A"

# The AWS secret access key to use.
AWS_SECRET_ACCESS_KEY = "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"
...
```

## S3 service

S3 service is the place where we collect static files. <br/>

- Create S3 service with next **Block public access** settings:

* [ ] Block all public access
* [ ] Block public access to buckets and objects granted through new access control lists (ACLs)
* [ ] Block public access to buckets and objects granted through any access control lists (ACLs)
* [x] Block public access to buckets and objects granted through new public bucket policies
* [x] Block public and cross-account access to buckets and objects through any public bucket policies

- Provide the name of the S3 bucket:

```python
# src/django_server/django_server/settings.py
...
S3_BUCKET = "name-of-your-s3-bucket"
...
```

## PostgreSQL [RDS database](https://console.aws.amazon.com/rds/):

- [Create](https://console.aws.amazon.com/rds/home) PostgreSQL database
- Replace `DATABASES` settings with new values:

```python
# src/django_server/django_server/settings.py
...
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'redfish-database-1', # dbname
        'USER': 'postgres', # master username
        'PASSWORD': 'oWdpawvro4zPdxzVobch', # master password
        'HOST': 'redfish-database-1.c7awambotayj.eu-central-1.rds.amazonaws.com', # Endpoint
        'PORT': '5432',
    }
}
...
```

_Note: We recommend you to set up [pgadmin](https://www.pgadmin.org/) to effectively manage your RDS instance. We cover this topic in the video tutorial._

## Almost there!

We need to deploy static, apply migrations, and create a super user. This require us to install dependencies. There is a way to avoid that by adding all needed commands to the `wsgi.py` file, but we not gonna do that. We explain this issues in the video tutorial.

## Establish [virtual environment](https://virtualenv.pypa.io/en/latest/)

```shell
./src/django_server$ virtualenv -p python3.7 venv
...
./src/django_server$ source venv/bin/activate
```

## Install dependencies

```shell
./src/django_server$ pip install -r requirements.txt
```

## Deploy static and apply migrations

```shell
./src/django_server$ python manage.py collectstatic
./src/django_server$ python manage.py migrate
```

## Create superuser

```shell
./src/django_server$ python manage.py createsuperuser
```

## Set production environment variables at `env.py` file:

```python
# src/django_server/django_server/env.py
# Production environment variables
ENV_PROD_VARIABLES = {
	'SERVER_URL': 'http://localhost:9000',
	'LANDING_URL': 'http://localhost:8000',
	'APPLICATION_URL': 'http://localhost:3000'
}
```

## Create `now.json` file withing the root directory and paste the content below:

```json
{
	"version": 2,
	"name": "your-app-prod",
	"builds": [
		{
			"src": "src/django_server/django_server/wsgi_prod.py",
			"use": "@ardnt/now-python-wsgi",
			"config": { "maxLambdaSize": "15mb" }
		}
	],
	"routes": [
		{
			"src": "/(.*)",
			"dest": "src/django_server/django_server/wsgi_prod.py"
		}
	]
}
```

## Make sure your remote repository is private and push your code there

```shell
$ git remote -v
$ git push
```

## Now makes your server live in few seconds

ZEIT Now will automatically build project each time you push code on GitHub.

## Host `react-app`

- Go to [Netlify](http://netlify.com);
- Click **New site from git** button;
- Authorize with GitHub;
- Pick your production repository;
- Set Build command to `npm run build`;
- Set Publish directory to `build`;
- Click **Deploy site**;
- Go to Site settings/Build & deploy and click Edit settings;
- Set **Base directory** to `src/react-app` and click save.

## Host `landing-page`

Repeat the same procedure but with next distinctions:

- Set **Publish directory** to `public`
- Set **Base directory** to `src/landing-page`

## Set up domain names

- Set up your domains on Zeit Now and Netlify.
- Switch to your development environment
- Set urls in `env.production` files at `react-app` and `landing-page` directories
- Do the same for the `env.py` file at `django_server/django_server/` directory
- Switch back to production
- Pull changes
- Push to GitHub

## That's it!

Everything should work. Otherwise, watch the video tutorial, or initiate an [issue](https://github.com/guandjoy/redfish/issues)
