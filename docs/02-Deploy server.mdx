# Deploy django server with ZEIT Now and AWS

In this tutorial, we explain how to deploy the Redfish server using [ZEIT Now](https://zeit.co/) and [AWS](https://aws.amazon.com/). However, you can deploy the Django server in another way. 

## 1. Setup environment
### 1.1. Make sure you have:
* accounts on [ZEIT](https://zeit.co/) and [AWS](https://aws.amazon.com/).
* installed [npm](https://www.npmjs.com/get-npm) and [python3.7](https://www.python.org/downloads/).
### 1.2. Install `now`:
```console
$ npm install -g now
```
_Make sure `now` have been installed:_
```console
$ now --version
15.8.0
```
### 1.3. Clone Redfish and navigate to the `django_server` directory:
```console
$ git clone https://github.com/guandjoy/redfish.git
```
```console
$ cd redfish/src/django_server
```
### 1.4. Create virtual environment
- Install `virtualenv` using `pip`:
```console
$ python3.7 -m pip install virtualenv
```
- Create and activate virtual environment:
```console
$ virtualenv -p python3.7 venv
```
```console
$ source venv/bin/activate
```
### 1.5. Install dependencies:
```console
$ pip install -r requirements.txt
```
### 1.6. Rename `settings.example.py` to `settings.py`:
```console
$ mv django_server/settings.example.py django_server/settings.py
```
## 2. Setup AWS
### 2.1. Provide AWS Region
* Go to [AWS Regions and Endpoints](https://docs.aws.amazon.com/general/latest/gr/rande.html), copy and paste the value of your region into the `settings.py` file;
```python
# settings.py
...
# The AWS region to connect to.
AWS_REGION = "eu-central-1"
...
```
### 2.2. Create AWS credentials.
* Go to [IAM Management Console](https://console.aws.amazon.com/iam/home?#/users) and __create a new user__ with __Programmatic access__.
* Create a group with __AmazonRDSFullAccess__ and __AmazonS3FullAccess__ policies and add created user there.
* Copy __Access Key ID__ and __Secret Access Key__ and paste them into `settings.py` file
```python
# settings.py
...
# The AWS access key to use.
AWS_ACCESS_KEY_ID = "AKIAR2BBJGZAVGG2RF6A"

# The AWS secret access key to use.
AWS_SECRET_ACCESS_KEY = "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"
...
```
### 2.2. Setup [S3 bucket](https://s3.console.aws.amazon.com/s3/):
S3 service is the place where we collect static files. \
* Create S3 service with next __Permissions block public access settings (bucket settings)__:
- [ ] Block all public access
- [ ] Block public access to buckets and objects granted through new access control lists (ACLs)
- [ ] Block public access to buckets and objects granted through any access control lists (ACLs)
- [x] Block public access to buckets and objects granted through new public bucket policies
- [x] Block public and cross-account access to buckets and objects through any public bucket policies
* Copy and Paste the name of the S3 bucket to the `settings.py` file:
```python
# settings.py
...
S3_BUCKET = "name-of-your-s3-bucket"
...
```
### 2.3. Setup [RDS database](https://console.aws.amazon.com/rds/):
* [Create](https://console.aws.amazon.com/rds/home) PostgreSQL database
* Set `DATABASES` in the `settings.py` file:
```python
# settings.py
...
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'redfish-database-1', # dbname
        'USER': 'postgres', # master username
        'PASSWORD': 'oWdpawvro4zPdxzVobch', # master password
        'HOST': 'redfish-database-1.c7awambotayj.eu-central-1.rds.amazonaws.com', # Endpoint
        'PORT': '5432',
    }
}
...
```
## 3. Create Google mail app passwords and setup SMTP server:
- Go to google app passwords: https://myaccount.google.com/apppasswords \
_Note: Make sure you turned on 2-step verification. Google restrict app passwords for users who don't._
- Select app: `mail`;
- Select device: `Other (custom name)`;
- Fill the name, e.g., `redfish-django-server`;
- Press `Generate` button;
- Copy and paste the `password` to the `settings.py` file and provide your `GMail email`:
```python
# settings.py
...
EMAIL_HOST_USER = 'example@gmail.com'
EMAIL_HOST_PASSWORD = 'vcnstblmegxxkvkf'
...
```

_* Provided credentials are not real and exposed only for demonstration purposes._
